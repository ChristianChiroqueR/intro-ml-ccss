# Exploraci√≥n avanzada

## Visualizaci√≥n de datos

La visualizaci√≥n de datos es un paso clave dentro del An√°lisis Exploratorio de Datos (EDA) en Machine Learning, porque nos permite ir m√°s all√° de los n√∫meros y comprender de manera intuitiva la informaci√≥n con la que vamos a trabajar. A trav√©s de gr√°ficos podemos detectar patrones, identificar tendencias, encontrar valores at√≠picos y comparar distribuciones de las variables, lo que facilita tomar decisiones sobre el preprocesamiento y la selecci√≥n de caracter√≠sticas.

En este curso utilizaremos ggplot2, un paquete del ecosistema tidyverse que se ha convertido en un est√°ndar para la visualizaci√≥n en R. Su fortaleza radica en la gram√°tica de los gr√°ficos, un enfoque que nos invita a construir visualizaciones combinando capas (datos, variables est√©ticas, geometr√≠as, temas) de manera flexible y reproducible.

Para Machine Learning, esta herramienta es fundamental: nos ayuda a explorar relaciones entre variables predictoras y la variable objetivo, a observar c√≥mo se distribuyen los datos y a detectar posibles problemas que, de no atenderse, afectar√≠an el desempe√±o de nuestros modelos.

### Retomamos nuestro dataset üìä

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(readxl)
data <- read_xlsx("data/AML_2.xlsx")
```

| Variable | C√≥mo debe leerse |
|-------------------------------------------|-----------------------------|
| `pais` | Nombre del pa√≠s. Identificaci√≥n de la unidad de an√°lisis. |
| `continente` | Continente al que pertenece el pa√≠s (ej. Am√©rica, Europa, Asia). |
| `region` | Subregi√≥n geogr√°fica m√°s espec√≠fica (ej. Sudam√©rica, √Åfrica Occidental). |
| `aml_index` | √çndice de Lavado de Activos seg√∫n **Basel AML Index**. Valores m√°s altos indican **mayor riesgo de lavado de activos y financiamiento del terrorismo**. |
| `matricula` | Porcentaje de la poblaci√≥n en edad escolar que est√° matriculada en el sistema educativo. |
| `pbi_pc` | Producto Bruto Interno per c√°pita (ingreso promedio por persona en d√≥lares). |
| `pobreza` | Nivel de pobreza en el pa√≠s (porcentaje de la poblaci√≥n bajo la l√≠nea de pobreza). |
| `urbano` | Porcentaje de la poblaci√≥n que reside en √°reas urbanas. |
| `educacion` | Porcentaje del PBI nacional destinado a educaci√≥n. |
| `cpi_index` | √çndice de Percepci√≥n de la Corrupci√≥n de **Transparencia Internacional**. Valores m√°s altos significan **menor percepci√≥n de corrupci√≥n**. |
| `rule_of_law` | √çndice de Estado de Derecho. Valores m√°s altos indican mayor confianza en las leyes, justicia y cumplimiento normativo. |
| `democracy_index` | √çndice de democracia (Economist Intelligence Unit). Valores m√°s altos indican reg√≠menes m√°s democr√°ticos. |
| `democracy_index_cat` | Categor√≠a del √≠ndice de democracia (ej. Democracia plena, Democracia defectuosa, R√©gimen h√≠brido, R√©gimen autoritario). |
| `organized_crime_index` | √çndice de criminalidad organizada. Valores m√°s altos reflejan mayor presencia e influencia de organizaciones criminales. |
| `organized_crime_index_cat` | Categor√≠a del √≠ndice de criminalidad organizada (ej. Baja, Media, Alta). |

Con la finalidad de que cpi_index tenga una intepretaci√≥n intuitiva vamos a invertir su escala:

```{r}
data <- data |> mutate(cpi_index=100-cpi_index)
```

### Anatom√≠a de un ggplot

![](images/capas.png)

`ggplot2` es un popular paquete de visualizaci√≥n de datos para el lenguaje de programaci√≥n R, basado en los principios de la "Gram√°tica de Gr√°ficos". Esta filosof√≠a de dise√±o permite a los usuarios construir gr√°ficos complejos y est√©ticamente agradables a partir de componentes b√°sicos de forma intuitiva y flexible.

El n√∫cleo de ggplot2 radica en su sistema de capas, donde cada gr√°fico se construye agregando capas que pueden incluir, entre otros, los datos, las est√©ticas (como color, forma y tama√±o), los objetos geom√©tricos (como puntos, l√≠neas y barras), las escalas, y las anotaciones. Este enfoque modular no solo facilita la personalizaci√≥n y optimizaci√≥n de los gr√°ficos sino que tambi√©n promueve una estructura de c√≥digo clara y comprensible.

Vamos a hacer un ejemplo paso a paso:

#### 1ra capa: Datos

Es el conjunto de datos a visualizar.

Nuestra primera capa siempre va a ser la data. Sobre esta iniciamos la funci√≥n ggplot y corroboramos que tenemos un lienzo en blanco.

```{r}
data |> 
  ggplot()
```

#### 2da capa: Est√©ticas

Es el dise√±o b√°sico del gr√°fico (Aesthetics).

Mapeo de variables a propiedades visuales como color, forma o tama√±o, definidas con aes().

A diferencia del lienzo en blanco, ya contamos con un dise√±o. En este caso, hemos indicado al R que el eje X ser√° la variable Pobreza.

```{r}
data |> 
  ggplot()+
  aes(x=aml_index)
```

::: callout-warning
En ggplot2, las capas de un gr√°fico se van adicionando secuencialmente utilizando el operador +.
:::

#### 3ra capa: Geometr√≠as (Geoms)

Son representaciones gr√°ficas de los datos, como puntos, l√≠neas o barras (geom_point(), geom_line(), geom_bar(), etc.).

En nuestro ejemplo, podemos agregar la geometr√≠a de puntos para hacer un scatterplot o diagrama de dispersi√≥n:

```{r}
data |> 
  ggplot()+
  aes(x=aml_index)+
  geom_histogram()
```

::: callout-note
En el paquete {ggplot2} existen 30 geometr√≠as disponibles. Puedes ver el detalle de estos en la [documentaci√≥n del paquete](https://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf).
:::

Esta estructura de capas hace que ggplot2 sea extremadamente √∫til para explorar y presentar datos de manera efectiva, permitiendo a los usuarios desde principiantes hasta expertos crear visualizaciones de datos complejas y personalizadas con relativa facilidad.

## Exploraci√≥n univariada: Target

La primera mirada debe dirigirse al target, la variable que queremos predecir. Revisar su distribuci√≥n nos dice si los valores est√°n concentrados en un rango estrecho o dispersos, si hay sesgos o valores extremos que podr√≠an distorsionar los resultados. Detectar estos patrones desde el inicio nos prepara para tomar decisiones informadas m√°s adelante en el preprocesamiento.

### Histogramas

En este caso, nuestra variable target es el AML Index, por ello, podr√≠amos comenzar con un histograma.

Este primer gr√°fico nos informa sobre la **distribuci√≥n** de la variable. Dicho de otra manera, describe con qu√© frecuencia aparecen ciertos valores o rangos de valores.

```{r}
#| fig-cap: "Histograma de la variable AML Index"
data |> 
  ggplot()+
  aes(x=aml_index)+
  geom_histogram()
```

::: callout-tip
Gu√≠ate con estas preguntas b√°sicas:

1.  ¬øQu√© forma tiene la distribuci√≥n? (sim√©trica como campana, se nota una cola a la derecha o izquierda, con varias ‚Äúmonta√±as‚Äù o unimodal).

2.  ¬øHay valores extremos que aparecen en los bordes?
:::

### Boxplots

Luego de tener una idea sobre la forma c√≥mo se distribuye la variable, podr√≠amos entrar a analizar su dispersi√≥n. La dispersi√≥n es indica qu√© tan extendidos o agrupados est√°n los datos alrededor de un punto central (la media o la mediana). Si bien ya podemos tener una idea de ello viendo un histograma, siempre es √∫til utilizar un boxplot.

El boxplot es un gr√°fico estad√≠stico que resume la informaci√≥n esencial de una variable num√©rica en un solo esquema. Se construye a partir de los cuartiles. Estos son medidas que dividen el conjunto de datos en partes ordenadas:

-   Primer cuartil (Q1): el valor por debajo del cual se encuentra el 25% de los datos.

-   Segundo cuartil (Q2): es la mediana (50%).

-   Tercer cuartil (Q3): el valor por debajo del cual se encuentra el 75% de los datos.

La caja representa el rango intercuart√≠lico (Q3 ‚Äì Q1), que concentra al 50% central de los datos. La l√≠nea dentro de la caja marca la mediana. Los bigotes se extienden hasta los valores que a√∫n se consideran normales, y los puntos fuera de ellos son los **outliers**.

```{r}
data |> 
  ggplot()+
  aes(y=aml_index)+ #Para que aparezca vertical
  geom_boxplot()
```

::: callout-tip
Gu√≠ate con estas preguntas b√°sicas:

1.  Mediana: ¬øest√° en el centro o hacia un lado de la caja? ‚Üí indica simetr√≠a o sesgo.

2.  Caja (Q1‚ÄìQ3): ¬øes ancha o angosta? ‚Üí muestra la variabilidad del 50% central.

3.  Bigotes: ¬øson largos o cortos? ¬øm√°s extendidos en un lado? ‚Üí refleja dispersi√≥n y asimetr√≠a.

4.  Outliers: ¬øhay puntos fuera de los bigotes? ¬øcu√°ntos y qu√© tan alejados?
:::

Si no lo tienes claro, te aconsejo que revisites los conceptos de media, mediana y moda como medidas de tendencia central. Su importancia radica en que simplifican el an√°lisis de grandes vol√∫menes de informaci√≥n, proporcionando un √∫nico valor representativo que ayuda a entender la naturaleza de los datos.

### Ejercicio en clase

Dibujemos un boxplot desde 0.

## Exploraci√≥n univariada: Predictoras

Analizar las distribuciones de los predictores de manera individual nos permite descubrir escalas muy diferentes, valores at√≠picos o categor√≠as poco representadas. Esta revisi√≥n inicial es clave para comprender la calidad y naturaleza de los insumos que alimentar√°n el modelo.

### Gr√°fico de barras

Comencemos con una variable categ√≥rica como continente. Antes hab√≠amos visto frecuencias utilizando summary() o count():

```{r}
data |> 
  count(continente)
```

Ahora podemos tambi√©n solicitar un gr√°fico de barras:

```{r}
data |> 
  ggplot()+
  aes(x=continente)+
  geom_bar()
```

O tambi√©n puedes utilizar una `extensi√≥n` de ggplot como ggchart:

```{r}
#install.packages("ggcharts")
library(ggcharts)
```

Y solicitamos un diagrama similar, pero con una mejor presentaci√≥n:

```{r}
data |> 
  bar_chart(x=continente)+
  geom_text(aes(label = n, hjust = "left"))
```

### Ejercicio en clase

Ya exploramos visualmente la variable target y tambi√©n una predictora, ahora genera tus propios gr√°ficos para:

-   matricula

-   pbi_pc

-   pobreza

-   educacion

-   democracy_index_cat

-   organized_crime_index_cat

## Exploraci√≥n multivariada

Cuando avanzamos a exploraci√≥n multivariada nuestro prop√≥sito debe ser analizar las interacciones entre las variables y analizar si encontramos alguna asociaci√≥n.

Esto es importante porque nuestro algoritmo de ML, sea un modelo tradicional o m√°s avanzado (deep learning) va a utilizar esas interacciones para realizar las predicciones.

Aqu√≠ hay una norma: si los predictores son malos, el modelo ser√° malo.

### Gr√°fico de dispersi√≥n

Se utiliza para ver la relaci√≥n entre dos variables num√©ricas. Aqu√≠ debemos recordar conceptos b√°sicos como el **plano cartesiano**, el cual es un sistema de coordenadas que se utiliza para representar y visualizar puntos en un espacio bidimensional.

Est√° compuesto por dos ejes perpendiculares, el eje horizontal o eje de las abscisas (X) y el eje vertical o eje de las ordenadas (Y).

Estos ejes se cruzan en un punto llamado origen, que se representa con las coordenadas (0,0). Cada punto en el plano cartesiano se representa mediante un par ordenado (x, y), donde ‚Äúx‚Äù indica la posici√≥n horizontal del punto a lo largo del eje X y ‚Äúy‚Äù indica la posici√≥n vertical del punto a lo largo del eje Y.

El plano cartesiano proporciona un marco de referencia visual que facilita la representaci√≥n gr√°fica de datos, funciones matem√°ticas, relaciones y patrones geom√©tricos, permitiendo el an√°lisis y la interpretaci√≥n de informaci√≥n en el contexto bidimensional.

```{r}
data |> 
  ggplot()+
  aes(x=cpi_index, y=aml_index)+
  geom_point()
```

::: callout-tip
Gu√≠ate con estas preguntas b√°sicas:

1.  ¬øLos puntos que vemos en el plano forman alguna figura como una l√≠nea? Mientras la l√≠nea sea m√°s clara, diremos que la relaci√≥n lineal ser√° alta En cambio si vemos una l√≠nea dif√≠cilmente, o simplemente una gran nube de puntos, podr√≠amos decir que la relaci√≥n lineal es baja.

2.  ¬øUna variable aumenta mientras la otra aumenta? Estamos frente a una relaci√≥n positiva o directa.

3.  ¬øUna variable aumenta mientras la otra disminuye? Estamos frente a una relaci√≥n negativa o indirecta.

4.  Ojo, puede mostrar tambi√©n una relaci√≥n no lineal.
:::

### Extra: Coeficiente de correlaci√≥n

Una medida que suele solicitarse junto con el gr√°fico de dispersi√≥n, es el coeficiente de correlaci√≥n. La correlaci√≥n es una medida que describe la relaci√≥n o asociaci√≥n entre dos variables num√©ricas.

El **coeficiente de correlaci√≥n de Pearson** indica la fuerza y la direcci√≥n de la relaci√≥n lineal entre las variables y se mide a trav√©s de un coeficiente denominado coeficiente de correlaci√≥n de Pearson.

El coeficiente puede tomar los valores en el rango de -1 a 1.

![](images/correlaciones.jpg)

Solicitemos el coeficiente de correlaci√≥n entre aml_index y cpi_index

```{r}
cor.test(data$aml_index, data$cpi_index)
```

::: callout-tip
Gu√≠ate con estas preguntas b√°sicas:

1.  **FUERZA**: Mientras el valor del coeficiente se aleje m√°s del 0 (sea m√°s grande como valor absoluto) ello indicar√° una mayor correlaci√≥n entre las dos variables num√©ricas.

2.  **DIRECCI√ìN**: Cuando el coeficiente tiene signo positivo, ello indicar√° que la relaci√≥n tiene sentido directo, es decir, mientras una variable aumenta, la otra aumenta. Si el signo es negativo, mientras una variable aumenta la otra disminuye.
:::

Tambi√©n puedes utilizar la siguiente escala referencial para guiar tu interpretaci√≥n:

![](images/correlacion_cohen.jpg)

Esto es importante para algunos algoritmos que suponen linealidad, como el caso de la Regresi√≥n Lineal.

### Ejercicio en clase

Crea los gr√°ficos de dispersi√≥n y calcula los coeficientes de correlaci√≥n que se obtiene del cruce de nuestra variable target (aml_index) y las predictoras:

-   matricula

-   pbi_pc

-   pobreza

-   urbano

-   educaci√≥n

-   rule_of_law

-   democracy_index

-   organized_crime_index

### Gr√°fico + Coeficiente

```{r}
library(corrplot)

solo_numericas <- data |> select(where(is.numeric))

corrplot(cor(solo_numericas, 
             use = "complete.obs"), 
         method="number", 
         type="lower",
         tl.cex=0.8,
        number.digits = 1)
```

## Valores perdidos

En la clase anterior ya te hab√≠a comentado sobre la importancia de detectar los NA o tambi√©n conocido como valores perdidos. Estos los podemos visualizar variable por variable utilizando la funci√≥n `summary()` o tambi√©n podemos utilizar otros paquetes como `skimr`:

```{r}
#| message: false
#| warning: false
#install.packages("skimr")
library(skimr)
```

Para una r√°pida exploraci√≥n podr√≠a utilizar la librer√≠a `skimr`:

```{r}
skim(data)
```

En este caso tambi√©n podemos visualizar los valores perdidos de nuestra base de datos a fin de poder tener una imagen de lo que nos estamos enfrentando y luego evaluar, durante el preprocesamiento, qu√© estrategia ser√° la m√°s adecuada para solucionarlos.

```{r}
#| message: false
#| warning: false
#install.packages("naniar")
library(naniar)
```

```{r}
data |> 
  vis_miss()
```

::: callout-tip
Gu√≠ate con estos criterios. Nos importa analizar por variable.

2.  Porcentaje BAJO (\<5%):Puedes eliminar esas filas sin perder mucha informaci√≥n o imputar.

3.  Porcentaje MEDIO (5-20%): Conviene imputar.

4.  Porcentaje ALTO (\>30%): Esa variable podr√≠a ser candidata a eliminarse, salvo que tenga relevancia en el an√°lisis.
:::

## Diagn√≥stico final de nuestro dataset

Para nuestra data podemos construir el siguiente reporte con cada uno de los pasos que dimos hasta el momento.

| Criterio | Diagn√≥stico |
|------------------------------------|------------------------------------|
| Predictoras categ√≥ricas | S√≠, se identifican factores ‚Üí requieren codificaci√≥n |
| Valores perdidos | Pocos NA en general ‚Üí viable imputar (mediana/moda) o eliminar casos puntuales. |
| Outliers | Variables como pbi_pc tienen valores extremos ‚Üí revisar si son errores o reales; aplicar transformaciones si corresponde. |
| Sesgo | Distribuciones sesgadas (ej. pbi_pc) ‚Üí aplicar transformaciones, si corresponde. |
| Escalas diferentes | Variables en distintas unidades (ej. miles vs %) ‚Üí aplicar transformaciones. |
